function randomGaussian(){do{var e=Math.random(2)-1,t=Math.random(2)-1,s=e*e+t*t}while(s>=1);return e*(s=Math.sqrt(-2*Math.log(s)/s))}class NeuralNetwork{constructor(e,t,s,n){e instanceof tf.Sequential?(this.model=e,this.input_nodes=t,this.hidden_nodes=s,this.output_nodes=n):(this.input_nodes=e,this.hidden_nodes=t,this.output_nodes=s,this.model=this.createModel())}copy(){return tf.tidy((()=>{const e=this.createModel(),t=this.model.getWeights(),s=[];for(let e=0;e<t.length;e++)s[e]=t[e].clone();return e.setWeights(s),new NeuralNetwork(e,this.input_nodes,this.hidden_nodes,this.output_nodes)}))}mutate(e){tf.tidy((()=>{const t=this.model.getWeights(),s=[];for(let n=0;n<t.length;n++){let o=t[n],r=t[n].shape,a=o.dataSync().slice();for(let t=0;t<a.length;t++)if(Math.random(1)<e){let e=a[t];a[t]=e+randomGaussian()}let i=tf.tensor(a,r);s[n]=i}this.model.setWeights(s)}))}dispose(){this.model.dispose()}predict(e){return tf.tidy((()=>{const t=tf.tensor2d([e]);return this.model.predict(t).dataSync()}))}createModel(){const e=tf.sequential(),t=tf.layers.dense({units:this.hidden_nodes,inputShape:[this.input_nodes],activation:"relu"});e.add(t);const s=tf.layers.dense({units:this.output_nodes,activation:"sigmoid"});return e.add(s),e}}function indexOfMax(e){if(0===e.length)return-1;for(var t=e[0],s=0,n=1;n<e.length;n++)e[n]>t&&(s=n,t=e[n]);return s}class Car{constructor(e){this.y=ROAD.bottom-120,this.x=Math.floor(350*Math.random())+1,this.speed=self_speed,this.score=0,this.fitness=0,this.car=document.createElement("div"),this.car.setAttribute("class","car"),this.car.style.left=`${this.x}px`,gameArea.appendChild(this.car),this.brain=e?e.copy():new NeuralNetwork(2*TOTAL_TRAFFIC+2+2,2*TOTAL_TRAFFIC,OUTPUT)}addscore(){this.score++}update(){let e=[],t=this.car.getBoundingClientRect();e.push(t.x),e.push(t.y),document.querySelectorAll(".enemy").forEach((function(s){let n=s.getBoundingClientRect();e.push(n.x-t.x),e.push(n.y-t.y)})),e.push(speed/10),e.push(this.speed/10);let s=this.brain.predict(e);switch(s=indexOfMax(s),s){case 0:break;case 1:this.x>0&&(this.x-=this.speed);break;case 2:this.x<ROAD.width-60&&(this.x+=this.speed);break;case 3:this.y>=0&&(this.y-=this.speed);break;case 4:this.y<ROAD.bottom-120&&(this.y+=this.speed);break}this.car.style.left=`${this.x}px`,this.car.style.top=`${this.y}px`}mutate(){this.brain.mutate(.1)}collide(){this.car.remove()}dispose(){this.brain.dispose()}}function nextGeneration(){calculateFitness();for(let e=0;e<TOTAL_CARS_PER_GEN;e++)cars[e]=pickOne();for(let e=0;e<TOTAL_CARS_PER_GEN;e++)savedcars[e].dispose();savedcars=[]}function pickOne(){let e=0,t=Math.random(1);for(;t>0;)t-=savedcars[e].fitness,e++;e--;let s=savedcars[e],n=new Car(s.brain);return n.mutate(),n}function calculateFitness(){let e=0;for(let t of savedcars)e+=t.score;for(let t of savedcars)t.fitness=t.score/e}const score=document.querySelector(".score"),gen=document.querySelector(".gen"),gameArea=document.querySelector(".gameArea"),ROAD=gameArea.getBoundingClientRect();var OUTPUT=3,gen_no=1,speed=6,self_speed=6,TOTAL_CARS_PER_GEN=50,TOTAL_TRAFFIC=4;let cars=[],savedcars=[];function moveLines(){document.querySelectorAll(".lines").forEach((function(e){e.y>=650&&(e.y-=740),e.y+=speed,e.style.top=e.y+"px"}))}function isCollide(e,t){return aRect=e.car.getBoundingClientRect(),bRect=t.getBoundingClientRect(),aRect.bottom<bRect.top||aRect.top>bRect.bottom||aRect.right<bRect.left||aRect.left>bRect.right}function moveEnemy(){document.querySelectorAll(".enemy").forEach((function(e){cars.forEach((function(t,s){isCollide(t,e)||(savedcars.push(cars.splice(s,1)[0]),t.collide())})),e.y>=750&&(e.y=-300,e.style.left=Math.floor(350*Math.random())+"px",cars.forEach((function(e){e.addscore(),score.innerHTML=`Score: ${e.score}`}))),e.y+=speed,e.style.top=e.y+"px"})),cars.forEach((function(e){e.update()})),0===cars.length&&(gen_no++,gen.innerHTML=`Generation: ${gen_no}`,score.innerHTML="Score: 0",nextGeneration())}function gamePlay(){moveLines(),moveEnemy(),window.requestAnimationFrame(gamePlay)}function setupGame(){for(gameArea.innerHTML="",window.requestAnimationFrame(gamePlay),x=0;x<5;x++){let e=document.createElement("div");e.setAttribute("class","lines"),e.y=150*x,e.style.top=e.y+"px",gameArea.appendChild(e)}tf.setBackend("cpu");for(let e=0;e<TOTAL_CARS_PER_GEN;e++)cars[e]=new Car;for(x=0;x<TOTAL_TRAFFIC;x++){let e=document.createElement("div");e.setAttribute("class","enemy"),e.y=350*(x+1)*-1,e.style.top=e.y+"px",e.style.backgroundColor=randomColor(),e.style.left=Math.floor(350*Math.random())+"px",gameArea.appendChild(e)}}function randomColor(){function e(){let e=Math.floor(256*Math.random()).toString(16);return("0"+String(e)).substr(-2)}return"#"+e()+e()+e()}document.getElementById("start").addEventListener("click",(function(){speed=parseInt(document.getElementById("ts").value),self_speed=parseInt(document.getElementById("cs").value),TOTAL_CARS_PER_GEN=parseInt(document.getElementById("cpg").value),TOTAL_TRAFFIC=parseInt(document.getElementById("cit").value),OUTPUT=parseInt(document.getElementById("control").value),document.getElementById("start").remove(),setupGame()}));
